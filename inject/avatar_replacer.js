const DEFAULT_AVATAR_PATTERNS=["https://seccdn.libravatar.org/avatar/","https://seccdn.libravatar.org/static/img/nobody/"],NEW_AVATAR="https://seccdn.libravatar.org/avatar/ef166b47449cc7e4e71cec1a2f826a70?s=100";let replaceTimeout,intervalId,updatesLast3Cycles=[0,0,0],checkInterval=5e3;function debouncedReplace(){clearTimeout(replaceTimeout),replaceTimeout=setTimeout(replaceAllDefaultAvatars,100)}function replaceAllDefaultAvatars(){let e=0;return document.querySelectorAll('img[src], [style*="background-image"]').forEach(t=>{try{if(t.dataset.avatarReplaced)return;let a="",r=!1;if("IMG"===t.tagName){if(a=t.src,r=DEFAULT_AVATAR_PATTERNS.some(e=>a.includes(e)),r){const r=new URL(a).searchParams.get("s")||"",n=new URL(NEW_AVATAR);r&&n.searchParams.set("s",r),t.src=n.toString(),t.dataset.avatarReplaced="true",e++}}else{const n=getComputedStyle(t).backgroundImage;if(n&&"none"!==n){const c=n.match(/url\(["']?(.*?)["']?\)/);if(c?.[1]&&(a=c[1],r=DEFAULT_AVATAR_PATTERNS.some(e=>a.includes(e)),r)){const r=new URL(a).searchParams.get("s")||"",n=new URL(NEW_AVATAR);r&&n.searchParams.set("s",r);const c=n.toString();t.style.backgroundImage=`url("${c.replace(/"/g,'\\"')}")`,t.dataset.avatarReplaced="true",e++}}}}catch(e){console.debug("头像处理跳过:",e)}}),updatesLast3Cycles.push(e),updatesLast3Cycles.shift(),adjustCheckInterval(),e}function adjustCheckInterval(){const e=updatesLast3Cycles.some(e=>e>0);!e&&checkInterval<3e4?(checkInterval=Math.min(3e4,2*checkInterval),clearInterval(intervalId),startIntervalCheck()):e&&checkInterval>1e3&&(checkInterval=Math.max(1e3,Math.floor(checkInterval/2)),clearInterval(intervalId),startIntervalCheck())}function startIntervalCheck(){clearInterval(intervalId),intervalId=setInterval(replaceAllDefaultAvatars,checkInterval)}const observer=new MutationObserver(e=>{e.filter(e=>"attributes"===e.type?"src"===e.attributeName||"style"===e.attributeName&&/background-image/.test(e.target.style.backgroundImage):e.addedNodes.length>0).length>0&&debouncedReplace()});function handlePopState(){debouncedReplace()}function handleVisibilityChange(){document.hidden?clearInterval(intervalId):(startIntervalCheck(),debouncedReplace())}if(observer.observe(document,{subtree:!0,childList:!0,attributes:!0,attributeFilter:["src","style"],characterData:!1}),document.addEventListener("DOMContentLoaded",()=>{requestIdleCallback(replaceAllDefaultAvatars,{timeout:1e3})}),window.addEventListener("load",()=>{debouncedReplace()}),window.history.pushState){const e=history.pushState;history.pushState=function(){const t=e.apply(this,arguments);return debouncedReplace(),t};const t=history.replaceState;history.replaceState=function(){const e=t.apply(this,arguments);return debouncedReplace(),e},window.addEventListener("popstate",handlePopState)}function cleanup(){observer.disconnect(),clearInterval(intervalId),clearTimeout(replaceTimeout),window.removeEventListener("popstate",handlePopState),document.removeEventListener("visibilitychange",handleVisibilityChange)}document.addEventListener("visibilitychange",handleVisibilityChange),startIntervalCheck(),window.addEventListener("beforeunload",cleanup);